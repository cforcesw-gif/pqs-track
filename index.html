<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>C-Force PQS Tracker</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #0b1220;
    color: #fff;
    padding: 20px;
}

.container {
    max-width: 1300px;
    margin: auto;
    background: #111827;
    padding: 20px;
    border-radius: 10px;
}

.header {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    margin-bottom: 25px;
}

.header img {
    position: absolute;
    left: 0;
    max-height: 170px;
}

.row {
    display: flex;
    gap: 50px;
}

.column {
    flex: 1;
}

label {
    font-weight: bold;
    display: block;
    margin-top: 10px;
}

input, textarea, select, button {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: none;
    margin-top: 5px;
}

.section {
    margin-top: 20px;
    background: #020617;
    padding: 15px;
    border-radius: 8px;
}

.elements {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
}

.element {
    padding: 10px;
    border-radius: 6px;
    text-align: center;
    cursor: pointer;
    font-weight: bold;
    border: 2px solid transparent;
}

.element.active {
    border-color: #fff;
}

.hidden {
    display: none;
}

.defect-box {
    padding: 12px;
    border-radius: 6px;
    margin-top: 10px;
}

video, img {
    width: 100%;
    max-width: 320px;
    margin-top: 10px;
    border-radius: 6px;
}

button {
    background: #22c55e;
    font-weight: bold;
    margin-top: 15px;
    cursor: pointer;
}

.success {
    display: none;
    margin-top: 15px;
    background: #14532d;
    padding: 10px;
    text-align: center;
    border-radius: 6px;
}
</style>
</head>

<body>

<div class="container">

<div class="header">
    <img src="d3e1dd97-fdec-4bc1-8f5e-1f0e1b8c9ee3.png">
    <h1>C-Force PQS Tracker</h1>
</div>

<div class="row">
    <div class="column">
        <label>Date</label>
        <input type="date" id="date" readonly>
    </div>
    <div class="column">
        <label>Employee Code</label>
        <input type="text" id="employee">
    </div>
    <div class="column">
        <label>Station</label>
        <select id="station">
            <option value="">Select</option>
            <option>STATION 3</option>
            <option>STATION 4</option>
            <option>STATION 5</option>
            <option>STATION 6</option>
            <option>STATION 7</option>
            <option>STATION 8</option>
            <option>STATION 10</option>
            <option>STATION 11</option>
            <option>STATION 12</option>
        </select>
    </div>
</div>

<label>Problem Description</label>
<textarea id="problem"></textarea>

<div class="section">
<h3>Result (Required)</h3>
<label><input type="radio" name="result" value="PASS" onchange="toggleFail()"> PALLET PASS</label>
<label><input type="radio" name="result" value="FAIL" onchange="toggleFail()"> PALLET FAIL</label>
</div>

<div class="section hidden" id="failClassification">
<h3>Failure Classification</h3>
<label><input type="checkbox" class="severity" value="Critical"> Critical</label>
<label><input type="checkbox" class="severity" value="Structural"> Structural</label>
<label><input type="checkbox" class="severity" value="Cosmetic"> Cosmetic</label>
</div>

<div class="section hidden" id="palletElements">

<h3>Top Deck</h3>
<div class="elements" id="topDeck"></div>

<h3 style="margin-top:20px">Bottom Deck</h3>
<div class="elements" id="bottomDeck"></div>

<div id="defectBox" class="defect-box hidden">
<h4>Select Defect</h4>
<div id="defectList"></div>
</div>

</div>

<div class="section">
<h3>PHOTO OF DEFECT</h3>
<video id="video" autoplay></video>
<img id="photo" class="hidden">
<button type="button" onclick="openCam()">Open Camera</button>
<button type="button" onclick="takePhoto()">Take Photo</button>
</div>

<button onclick="savePQS()">Save PQS & Add New</button>
<div class="success" id="success">âœ” PQS Saved (Local Only)</div>

</div>

<script>
const elementColors = {
TB1A:"#2563eb",TB2A:"#7c3aed",TB3A:"#db2777",TB3B:"#ea580c",TB3C:"#16a34a",TB2B:"#0d9488",TB1B:"#9333ea",
BB10A:"#1d4ed8",BB10B:"#2563eb",BB11A:"#4f46e5",BB12A:"#7c3aed",BB12B:"#9333ea",
ST4A:"#be123c",ST4B:"#e11d48",ST5A:"#f43f5e",
BL6A:"#15803d",BL6B:"#16a34a",BL6C:"#22c55e",BL6D:"#4ade80",
BL7A:"#0f766e",BL7B:"#14b8a6",BL8A:"#0d9488",BL8B:"#06b6d4",BL9A:"#0284c7"
};

const topDeck=["TB1A","TB2A","TB3A","TB3B","TB3C","TB2B","TB1B"];
const bottomDeck=["BB10A","BB10B","BB11A","BB12A","BB12B","ST4A","ST4B","ST5A","BL6A","BL6B","BL6C","BL6D","BL7A","BL7B","BL8A","BL8B","BL9A"];

const defects=[
["CH","Chip / Hole"],["HS","Horizontal Split"],["VS","Vertical Split"],
["ME","Missing Element"],["SQ","Squareness"],["DA","Other Damage"],
["PN","Protruding Nail"],["RN","Raised Nail"],["MN","Missing Nail"]
];

let elementResults={};
let stream=null;

date.value=new Date().toISOString().split("T")[0];

function renderDeck(id,arr){
  const c=document.getElementById(id);
  arr.forEach(el=>{
    const d=document.createElement("div");
    d.className="element";
    d.style.background=elementColors[el];
    d.innerText=el;
    d.onclick=()=>selectElement(el,d);
    c.appendChild(d);
  });
}
renderDeck("topDeck",topDeck);
renderDeck("bottomDeck",bottomDeck);

function toggleFail(){
  const r=document.querySelector('input[name="result"]:checked')?.value;
  failClassification.classList.toggle("hidden",r!=="FAIL");
  palletElements.classList.toggle("hidden",r!=="FAIL");
}

function selectElement(el,div){
  document.querySelectorAll(".element").forEach(e=>e.classList.remove("active"));
  div.classList.add("active");
  defectBox.style.background=elementColors[el];
  defectList.innerHTML="";
  defects.forEach(d=>{
    defectList.innerHTML+=`
<label>
<input type="radio" name="defect" onclick="selectDefect('${el}','${d[0]} - ${d[1]}')">
${d[0]} - ${d[1]}
</label><br>`;
  });
  defectBox.classList.remove("hidden");
}

function selectDefect(el,val){
  elementResults[el]=val;
}

function openCam(){
  navigator.mediaDevices.getUserMedia({video:true})
  .then(s=>{stream=s;video.srcObject=s;});
}

function takePhoto(){
  const c=document.createElement("canvas");
  c.width=video.videoWidth;
  c.height=video.videoHeight;
  c.getContext("2d").drawImage(video,0,0);
  photo.src=c.toDataURL("image/png");
  photo.classList.remove("hidden");
}

function savePQS(){
  if(!employee.value || !station.value || Object.keys(elementResults).length === 0 || !photo.src){
    alert("Please complete all required fields and take a photo");
    return;
  }

  const failureClassification = [...document.querySelectorAll(".severity:checked")]
    .map(c => c.value)
    .join(", ");

fetch("https://script.google.com/macros/s/AKfycbz44G4wxSpwD5iIf8NYZSztbu22tZ8SbHvfoCZrz2JIV9owZ88bWg5D2c9Cp8I42fRafQ/exec", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      date: date.value,
      employee: employee.value,
      station: station.value,
      problem: problem.value,
      result: document.querySelector('input[name="result"]:checked')?.value,
      failureClassification: failureClassification,
      elements: elementResults,   // ðŸ”‘ TB1A â†’ defect
      photo: photo.src.split(",")[1]
    })
  })
  .then(() => {
    showSuccess();
    resetForm();
  })
  .catch(err => {
    alert("Error saving PQS");
    console.error(err);
  });
}

function showSuccess(){
  success.style.display="block";
  setTimeout(()=>success.style.display="none",2000);
}

function resetForm(){
  employee.value="";
  station.value="";
  problem.value="";
  document.querySelectorAll("input[type=radio],input[type=checkbox]").forEach(i=>i.checked=false);
  document.querySelectorAll(".element").forEach(e=>e.classList.remove("active"));
  elementResults={};
  failClassification.classList.add("hidden");
  palletElements.classList.add("hidden");
  defectBox.classList.add("hidden");
  photo.src="";
  photo.classList.add("hidden");
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
}
</script>

</body>
</html>
